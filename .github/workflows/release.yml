name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to create release for'
        required: true
        default: 'v0.1.0'

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            lib_name: libtime_tracking_nvim.so
            nvim_name: time_tracking_nvim.so
          - target: x86_64-apple-darwin
            os: macos-latest
            lib_name: libtime_tracking_nvim.dylib
            nvim_name: time_tracking_nvim.dylib
          - target: aarch64-apple-darwin
            os: macos-latest
            lib_name: libtime_tracking_nvim.dylib
            nvim_name: time_tracking_nvim.dylib
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            lib_name: time_tracking_nvim.dll
            nvim_name: time_tracking_nvim.dll

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}

      - name: Create plugin structure
        shell: bash
        run: |
          mkdir -p plugin-structure/target/release
          
          # Copy the built library with the correct naming for Neovim
          cp target/${{ matrix.target }}/release/${{ matrix.lib_name }} plugin-structure/target/release/${{ matrix.nvim_name }}

      - name: Copy plugin files
        shell: bash
        run: |
          # Copy lua files
          if [ -d "lua" ]; then
            cp -r lua plugin-structure/
          fi
          
          # Copy plugin files
          if [ -d "plugin" ]; then
            cp -r plugin plugin-structure/
          fi
          
          # Copy documentation and metadata
          if [ -f "README.md" ]; then
            cp README.md plugin-structure/
          fi
          
          if [ -f "LICENSE" ]; then
            cp LICENSE plugin-structure/
          fi

      - name: Package plugin
        shell: bash
        run: |
          cd plugin-structure
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            7z a ../time-tracking-nvim-${{ matrix.target }}.zip .
          else
            tar -czf ../time-tracking-nvim-${{ matrix.target }}.tar.gz .
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: time-tracking-nvim-${{ matrix.target }}
          path: |
            time-tracking-nvim-${{ matrix.target }}.*
          retention-days: 1

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get tag name
        id: get_tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -name "*.tar.gz" -o -name "*.zip" | while read file; do
            cp "$file" release-assets/
          done
          ls -la release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag }}
          name: Release ${{ steps.get_tag.outputs.tag }}
          draft: false
          prerelease: false
          files: release-assets/*
          body: |
            ## Time Tracking Neovim Plugin ${{ steps.get_tag.outputs.tag }}
            
            ### Installation
            
            #### Using lazy.nvim
            ```lua
            {
              "stevenwcarter/time-tracking-nvim",
              tag = "${{ steps.get_tag.outputs.tag }}",
              config = function()
                require("time-tracking-nvim").setup()
              end,
            }
            ```
            
            ### Downloads
            
            Choose the appropriate binary for your platform:
            - **Linux x86_64**: `time-tracking-nvim-x86_64-unknown-linux-gnu.tar.gz`
            - **macOS Intel**: `time-tracking-nvim-x86_64-apple-darwin.tar.gz`  
            - **macOS Apple Silicon**: `time-tracking-nvim-aarch64-apple-darwin.tar.gz`
            - **Windows**: `time-tracking-nvim-x86_64-pc-windows-msvc.zip`
            
            ### Changes
            
            - Built with Rust for optimal performance
            - Live preview updates as you edit markdown files
            - Automatic window management
            - Cross-platform support
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}